<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Injecting JavaScript into Custom API and replaying AJAX calls · Docs Suite</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;div class=&quot;entry-content&quot;&gt;"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Injecting JavaScript into Custom API and replaying AJAX calls · Docs Suite"/><meta property="og:type" content="website"/><meta property="og:url" content="https://diffbot.github.io/"/><meta property="og:description" content="&lt;div class=&quot;entry-content&quot;&gt;"/><meta property="og:image" content="https://diffbot.github.io/img/diagram.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://diffbot.github.io/img/diagram.svg"/><link rel="shortcut icon" href="/img/diffbot-head.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/app.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/diffbot_white.svg" alt="Docs Suite"/><h2 class="headerTitleWithLogo">Docs Suite</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/en/error-intro" target="_self">Debugging</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/diffbot/docs/edit/master/docs/guides-injecting-javascript-replaying-ajax.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Injecting JavaScript into Custom API and replaying AJAX calls</h1></header><article><div><span><div class="entry-content">
        <p>Example: we need a category from a webshop like <a href="https://www.balenciaga.com/hk/top_cod12022446qd.html">Balenciaga.com</a>.</p>
<p><img src="img/balenciaga.png" alt=""></p>
<p>We can see that the category is somewhat contained in the URL ("top") but there must be something more obvious. If we look through the network calls issued as the page is loading, we’ll notice some things.</p>
<p><img src="/img/balenciaga02.png" alt=""></p>
<p>Through trial and error, we can inspect each of the individual calls being made via JavaScript as the page is getting loaded until we reach a useful one. GetDataLayer is the one we need.</p>
<p><img src="/img/03.png" alt=""></p>
<p>This is one of the few calls that return JSON data rather than text or HTML, indicating it’s used to populate data in a template, the template being a blank "product" page. Let’s scroll down.</p>
<p><img src="/img/04.png" alt=""></p>
<p>Bingo! Product category is neatly fetched for us.</p>
<p>But we cannot access the data from an XHR call unless we either re-issue the call with custom JavaScript, or find it stored somewhere in the page.  The latter is simpler so let’s try that approach first.</p>
<h3 id="ipt_kb_toc_1308_0">Grabbing from the page</h3>
<p>We start our search by trying to find which element in the DOM might be related to this data. If we go to the Elements tab of the dev tools, we can search for the category "tops" which we’ve identified in the above network call. This will lead us to the following element:</p>
<p><img src="/img/05.png" alt=""></p>
<p>We can see that it’s part of the value of the attribute called "data-ytos-track". Data attributes are fetched in JavaScript without the "data" prefix, so let’s see if there’s an "ytos-track" object in the JavaScript environment we could use.</p>
<p>Enter the console, and if you just start typing <code>y</code>, you’ll notice <code>yTos</code> appear in the list.</p>
<p><img src="/img/06.png" alt=""></p>
<p>A few minutes of exploration later, and we can find the product category and micro category under <code>yTos.configuration.dataLayer</code>.</p>
<p><img src="/img/07.png" alt=""></p>
<p>Now it’s just a matter of a simple JS script we’ll inject into the headers. This should do:</p>
<pre><code class="hljs css language-js"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    start();

    <span class="hljs-comment">// Add an element into the DOM from which we'll select (in the CUSTOM API) some of the values we generate with X-evaluate</span>
    <span class="hljs-built_in">document</span>.body.innerHTML += <span class="hljs-string">'&amp;lt;div id="diffbot-output"&amp;gt;&amp;lt;/div&amp;gt;'</span>;
    <span class="hljs-keyword">var</span> node = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);
    node.id = <span class="hljs-string">"output"</span>;
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"container"</span>).appendChild(node);

    <span class="hljs-comment">// Define the categories by extracting them from the JS object in the page</span>
    <span class="hljs-keyword">var</span> productCategory = yTos.configuration.dataLayer.product_category;
    <span class="hljs-keyword">var</span> productMicro = yTos.configuration.dataLayer.product_micro;

    <span class="hljs-comment">// Put the values into the generated elements</span>
    <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">"#diffbot-output"</span>).innerHTML += <span class="hljs-string">'&amp;lt;div class="productCategory"&amp;gt;'</span> + productCategory + <span class="hljs-string">'&amp;lt;/div&amp;gt;'</span>;
    <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">"#diffbot-output"</span>).innerHTML += <span class="hljs-string">'&amp;lt;div class="productMicro"&amp;gt;'</span> + productMicro + <span class="hljs-string">'&amp;lt;/div&amp;gt;'</span>;

    end();
}
</code></pre>
<p>This should be <a href="https://www.minifier.org/">minified</a> and then placed into your <a href="http://tldrify.com/jao">X-evaluate header for the API call</a>.</p>
<p>Note: <em>The <a href="https://app.diffbot.com">New Dashboard</a> provides the functionality in the UI, but if you don’t have access to it yet, please <a href="mailto:support@diffbot.com">talk to support</a>.</em></p>
<h3 id="ipt_kb_toc_1308_1">Repeating the XHR call</h3>
<p>Sometimes the JS data fetched via a network call won’t be pasted into the DOM so obviously, and we’ll need to get creative. We’ll need to re-request the network call, but then grab the data for ourselves. Here’s the script to do that in the above case:</p>
<pre><code class="hljs css language-js"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    start();

    <span class="hljs-comment">// Prepare a new AJAX call</span>
    <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
    <span class="hljs-keyword">var</span> arr = location.href.match(<span class="hljs-regexp">/_[a-z]+(\w+)\.html+/</span>);
    <span class="hljs-keyword">var</span> id = arr[<span class="hljs-number">1</span>];
    <span class="hljs-comment">// Cancel call if there's no ID (no SKU) in the URL</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">undefined</span> === arr[<span class="hljs-number">1</span>] || arr[<span class="hljs-number">1</span>] === <span class="hljs-string">''</span>) {
        end();
    }
    
    <span class="hljs-comment">// Add element into which we'll put the output</span>
    <span class="hljs-built_in">document</span>.body.innerHTML += <span class="hljs-string">'&amp;lt;div id="diffbot-output"&amp;gt;&amp;lt;/div&amp;gt;'</span>;
    
    <span class="hljs-comment">// Initiate an AJAX call to the site's data provider API, and inject the code we harvested from the URL.</span>
    xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://www.balenciaga.com/yTos/api/Plugins/SeoPluginApi/GetDataLayer?itemCode10='</span> + id + <span class="hljs-string">'&amp;amp;itemSiteCode=BALENCIAGA_HK&amp;amp;controller=item&amp;amp;area=&amp;amp;action=index'</span>);

    <span class="hljs-comment">// Define an event listener which executes when the AJAX call completes</span>
    xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-comment">// Create an output element in the DOM</span>
        <span class="hljs-keyword">var</span> node = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);
        node.id = <span class="hljs-string">"output"</span>;
        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"container"</span>).appendChild(node);
        
        <span class="hljs-comment">// If the call was successful</span>
        <span class="hljs-keyword">if</span> (xhr.status === <span class="hljs-number">200</span>) {

            <span class="hljs-comment">// Grab categories and inject them into the placeholder elements</span>
            <span class="hljs-keyword">var</span> productCategory = <span class="hljs-built_in">JSON</span>.parse(xhr.responseText)[<span class="hljs-string">'product_category'</span>];
            <span class="hljs-keyword">var</span> productMicro = <span class="hljs-built_in">JSON</span>.parse(xhr.responseText)[<span class="hljs-string">'product_micro'</span>];
            <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">"#diffbot-output"</span>).innerHTML += <span class="hljs-string">'&amp;lt;div class="productCategory"&amp;gt;'</span> + productCategory + <span class="hljs-string">'&amp;lt;/div&amp;gt;'</span>;
            <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">"#diffbot-output"</span>).innerHTML += <span class="hljs-string">'&amp;lt;div class="productMicro"&amp;gt;'</span> + productMicro + <span class="hljs-string">'&amp;lt;/div&amp;gt;'</span>;

            <span class="hljs-comment">// Otherwise, write out the error into the output element</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">"#diffbot-output"</span>).innerText = <span class="hljs-string">"Error"</span>;
        }

        <span class="hljs-comment">// Once this is all done, give the browser 0.5 seconds to sober up and finalize, then call end.</span>
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            end();
        }, <span class="hljs-number">500</span>);
    };

    <span class="hljs-comment">// Call the AJAX request</span>
    xhr.send();

    <span class="hljs-comment">// Wait up to 10 seconds for the AJAX request to finish, if still not done, cancel by calling end.</span>
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        end();
    }, <span class="hljs-number">10000</span>);
}
</code></pre>
<p>Arguably much more complex and slower, but helps when you don’t have access to the data in the page’s environment like above. Again, this needs to be minified and included in the headers of the Diffbot API request.</p>
<h3 id="ipt_kb_toc_1308_2">Results</h3>
<p>The results are as expected. Alongside a typical Diffbot category which is assumed, we have two very precise vendor-provided categories.</p>
<p><img src="/img/08.png" alt=""></p>
            </div>
</span></div></article></div><div class="docLastUpdate"><em>Last updated by Bruno Skvorc</em></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/diffbot_white.svg" alt="Docs Suite" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/en/api-basics-index">Extraction</a><a href="/docs/en/cb-basics-index">Crawling</a><a href="/docs/en/kg-index">Knowledge Graph</a><a href="/docs/en/explain-gdpr">Diffbot and GDPR</a></div><div><h5>Community</h5><a href="https://stackoverflow.com/questions/tagged/diffbot" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://twitter.com/diffbot" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/blog">Blog</a><a href="/help">Help</a><a href="https://github.com/diffbot">GitHub</a></div></section><a href="https://diffbot.com/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/img/diffbot_white.svg" alt="Diffbot.com" width="170" height="45"/></a><section class="copyright">Copyright © 2024 Diffbot.com</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '2c24e5e78d724e77c46ef1b720700177',
                indexName: 'diffbot',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>